---
phase: 14-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/admin/src/lib/supabase.ts
  - apps/admin/src/contexts/AuthContext.tsx
  - apps/admin/src/components/ProtectedRoute.tsx
autonomous: true

must_haves:
  truths:
    - "Supabase client initialized with env vars"
    - "AuthContext provides session state to components"
    - "ProtectedRoute redirects unauthenticated users"
  artifacts:
    - path: "apps/admin/src/lib/supabase.ts"
      provides: "Typed Supabase client"
      contains: "createClient"
    - path: "apps/admin/src/contexts/AuthContext.tsx"
      provides: "Auth state management"
      contains: "onAuthStateChange"
    - path: "apps/admin/src/components/ProtectedRoute.tsx"
      provides: "Route protection wrapper"
      contains: "Navigate"
  key_links:
    - from: "supabase.ts"
      to: "@alvarocortes/shared"
      via: "Database type import"
    - from: "AuthContext.tsx"
      to: "supabase.ts"
      via: "supabase.auth methods"
    - from: "ProtectedRoute.tsx"
      to: "AuthContext.tsx"
      via: "useAuth hook"
---

<objective>
Create authentication infrastructure: Supabase client, auth context, and protected route wrapper.

Purpose: Establish foundational auth components that login flow and protected routes will build upon.
Output: Typed Supabase client, AuthContext with session management, ProtectedRoute component.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-admin-foundation/13-RESEARCH.md
@.planning/phases/13-admin-foundation/13-02-SUMMARY.md

Existing admin app structure:
@apps/admin/src/main.tsx
@apps/admin/src/App.tsx
@apps/admin/package.json

Database types:
@packages/shared/src/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase client with types</name>
  <files>apps/admin/src/lib/supabase.ts</files>
  <action>
Create typed Supabase client:

```typescript
import { createClient } from '@supabase/supabase-js'
import type { Database } from '@alvarocortes/shared'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase environment variables')
}

export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey)
```

This provides type-safe database queries throughout the admin app.
  </action>
  <verify>File exists with createClient and Database type import</verify>
  <done>Supabase client created with TypeScript types from shared package</done>
</task>

<task type="auto">
  <name>Task 2: Create AuthContext with session management</name>
  <files>apps/admin/src/contexts/AuthContext.tsx</files>
  <action>
Create AuthContext with:
- Session state (User | null)
- Loading state for initial session check
- signInWithGitHub function
- signOut function
- useAuth hook for consuming context

```typescript
import { createContext, useContext, useEffect, useState, type ReactNode } from 'react'
import type { User, Session } from '@supabase/supabase-js'
import { supabase } from '@/lib/supabase'

interface AuthContextType {
  user: User | null
  session: Session | null
  loading: boolean
  signInWithGitHub: () => Promise<void>
  signOut: () => Promise<void>
}

const AuthContext = createContext<AuthContextType | undefined>(undefined)

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null)
  const [session, setSession] = useState<Session | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session)
      setUser(session?.user ?? null)
      setLoading(false)
    })

    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (_event, session) => {
        setSession(session)
        setUser(session?.user ?? null)
        setLoading(false)
      }
    )

    return () => subscription.unsubscribe()
  }, [])

  const signInWithGitHub = async () => {
    await supabase.auth.signInWithOAuth({
      provider: 'github',
      options: {
        redirectTo: `${window.location.origin}/auth/callback`
      }
    })
  }

  const signOut = async () => {
    await supabase.auth.signOut()
  }

  return (
    <AuthContext.Provider value={{ user, session, loading, signInWithGitHub, signOut }}>
      {children}
    </AuthContext.Provider>
  )
}

export function useAuth() {
  const context = useContext(AuthContext)
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider')
  }
  return context
}
```

Key behaviors:
- getSession() on mount checks for existing session
- onAuthStateChange() subscribes to auth events (login, logout, token refresh)
- loading state prevents flash of unauthenticated content
  </action>
  <verify>File exists with AuthProvider, useAuth hook, and onAuthStateChange subscription</verify>
  <done>AuthContext provides session state and auth methods to entire app</done>
</task>

<task type="auto">
  <name>Task 3: Create ProtectedRoute component</name>
  <files>apps/admin/src/components/ProtectedRoute.tsx</files>
  <action>
Create ProtectedRoute that:
- Shows loading spinner while checking auth
- Redirects to /login if not authenticated
- Renders children if authenticated

```typescript
import { Navigate } from 'react-router-dom'
import { useAuth } from '@/contexts/AuthContext'

interface ProtectedRouteProps {
  children: React.ReactNode
}

export function ProtectedRoute({ children }: ProtectedRouteProps) {
  const { user, loading } = useAuth()

  if (loading) {
    return (
      <div className="min-h-screen bg-neutral-900 flex items-center justify-center">
        <div className="text-white">Loading...</div>
      </div>
    )
  }

  if (!user) {
    return <Navigate to="/login" replace />
  }

  return <>{children}</>
}
```

This component wraps protected routes to enforce authentication.
  </action>
  <verify>File exists with Navigate import and useAuth usage</verify>
  <done>ProtectedRoute redirects unauthenticated users to login</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] apps/admin/src/lib/supabase.ts exists with typed client
- [ ] apps/admin/src/contexts/AuthContext.tsx exports AuthProvider and useAuth
- [ ] apps/admin/src/components/ProtectedRoute.tsx uses useAuth and Navigate
- [ ] `bun run type-check` passes in admin app
</verification>

<success_criteria>

- All tasks completed
- Type-check passes
- Auth infrastructure ready for login flow
  </success_criteria>

<output>
After completion, create `.planning/phases/14-authentication/14-01-SUMMARY.md`
</output>
