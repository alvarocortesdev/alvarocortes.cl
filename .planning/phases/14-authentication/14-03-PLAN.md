---
phase: 14-authentication
plan: 03
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - supabase/migrations/20260126100000_update_admin_uuid.sql
autonomous: false

must_haves:
  truths:
    - "Admin UUID updated in RLS policies"
    - "Only owner can modify database content"
    - "Public can still read published content"
  artifacts:
    - path: "supabase/migrations/20260126100000_update_admin_uuid.sql"
      provides: "RLS policy updates with real admin UUID"
      contains: "auth.uid()"
  key_links:
    - from: "RLS policies"
      to: "auth.uid()"
      via: "UUID comparison in policy"
---

<objective>
Update RLS policies with actual admin UUID after first successful login.

Purpose: Enable admin write access to database by replacing placeholder UUID.
Output: Working RLS policies that allow only the owner to modify content.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-admin-foundation/13-RESEARCH.md
@.planning/phases/14-authentication/14-02-SUMMARY.md

Existing migration with placeholder:
@supabase/migrations/20260126000000_create_cms_tables.sql
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Login and provide your admin UUID</action>
  <instructions>
Now that GitHub OAuth is configured, login to get your admin UUID:

1. Visit https://admin.alvarocortes.cl
2. Click "Sign in with GitHub"
3. Authorize the app
4. After redirect, you'll see your User ID displayed on the dashboard

Copy the User ID (UUID format like `12345678-1234-1234-1234-123456789abc`)
  </instructions>
  <verification>Dashboard displays your GitHub username and UUID</verification>
  <resume-signal>Paste your admin UUID (e.g., "12345678-1234-1234-1234-123456789abc")</resume-signal>
</task>

<task type="auto">
  <name>Task 1: Create migration to update admin UUID in RLS policies</name>
  <files>supabase/migrations/20260126100000_update_admin_uuid.sql</files>
  <action>
Create migration that updates all admin policies with the real UUID.

Replace ADMIN_UUID with the UUID provided by the user:

```sql
-- Update admin UUID in all RLS policies
-- Replace placeholder with actual admin auth.uid()

-- Drop existing admin policies
DROP POLICY IF EXISTS "Admin can do everything with posts" ON posts;
DROP POLICY IF EXISTS "Admin can do everything with projects" ON projects;
DROP POLICY IF EXISTS "Admin can do everything with timeline" ON timeline_entries;
DROP POLICY IF EXISTS "Admin can do everything with categories" ON tech_categories;
DROP POLICY IF EXISTS "Admin can do everything with technologies" ON technologies;

-- Recreate with actual admin UUID
CREATE POLICY "Admin can do everything with posts"
ON posts FOR ALL
USING ((SELECT auth.uid()) = 'ADMIN_UUID'::uuid);

CREATE POLICY "Admin can do everything with projects"
ON projects FOR ALL
USING ((SELECT auth.uid()) = 'ADMIN_UUID'::uuid);

CREATE POLICY "Admin can do everything with timeline"
ON timeline_entries FOR ALL
USING ((SELECT auth.uid()) = 'ADMIN_UUID'::uuid);

CREATE POLICY "Admin can do everything with categories"
ON tech_categories FOR ALL
USING ((SELECT auth.uid()) = 'ADMIN_UUID'::uuid);

CREATE POLICY "Admin can do everything with technologies"
ON technologies FOR ALL
USING ((SELECT auth.uid()) = 'ADMIN_UUID'::uuid);
```

After creating the file, apply the migration:
```bash
npx supabase db push
```
  </action>
  <verify>supabase db push succeeds without errors</verify>
  <done>RLS policies updated with real admin UUID</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Updated RLS policies with your admin UUID</what-built>
  <how-to-verify>
    1. Visit https://admin.alvarocortes.cl
    2. Login with GitHub (should still work)
    3. Verify you can see the dashboard
    4. In Supabase Dashboard → Table Editor → posts
    5. Try to insert a test row (should succeed as admin)
    6. Open an incognito window, visit https://admin.alvarocortes.cl
    7. Should redirect to login (not show dashboard)
  </how-to-verify>
  <resume-signal>Type "verified" if auth works correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Admin UUID migration created and applied
- [ ] Admin can login via GitHub OAuth
- [ ] Admin can access protected dashboard
- [ ] Session persists across page refresh
- [ ] Logout clears session
- [ ] Unauthenticated users redirected to login
- [ ] Admin can write to database (RLS allows)
</verification>

<success_criteria>

- All tasks completed
- All AUTH-* requirements satisfied
- RLS policies enforce single-admin access
  </success_criteria>

<output>
After completion, create `.planning/phases/14-authentication/14-03-SUMMARY.md`
</output>
