---
phase: 01-monorepo-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified: [vitest.config.ts, apps/web/vitest.config.ts, packages/api/vitest.config.ts, apps/web/src/test/setup.ts, apps/web/src/App.test.tsx, packages/api/src/routes/health.test.ts, eslint.config.js, .prettierrc, .prettierignore, apps/web/package.json, packages/api/package.json, package.json]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "bun test runs Vitest across all packages"
    - "bun lint checks code quality"
    - "Tests pass for both web and api packages"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Root Vitest projects configuration"
      contains: "projects"
    - path: "apps/web/vitest.config.ts"
      provides: "Web package test configuration"
      contains: "happy-dom"
    - path: "packages/api/vitest.config.ts"
      provides: "API package test configuration"
      contains: "name.*api"
    - path: "eslint.config.js"
      provides: "ESLint flat config"
      contains: "export default"
  key_links:
    - from: "vitest.config.ts"
      to: "apps/web/vitest.config.ts"
      via: "projects glob"
      pattern: "apps.*/vitest.config.ts"
    - from: "vitest.config.ts"
      to: "packages/api/vitest.config.ts"
      via: "projects glob"
      pattern: "packages.*/vitest.config.ts"
---

<objective>
Configure testing with Vitest and code quality with ESLint/Prettier.

Purpose: Enable testing and maintain code quality across the monorepo.
Output: Working test suite with Vitest, ESLint flat config, and Prettier formatting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/phases/01-monorepo-foundation/01-02-SUMMARY.md
@.planning/phases/01-monorepo-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install testing and linting dependencies</name>
  <files>package.json, apps/web/package.json, packages/api/package.json</files>
  <action>
Update root package.json devDependencies:
```json
{
  "devDependencies": {
    "turbo": "^2.5.5",
    "typescript": "^5.7.2",
    "vitest": "^3.2.0",
    "vite-tsconfig-paths": "^5.0.0",
    "eslint": "^9.18.0",
    "@eslint/js": "^9.18.0",
    "typescript-eslint": "^8.21.0",
    "eslint-plugin-react-hooks": "^5.1.0",
    "eslint-plugin-react-refresh": "^0.4.18",
    "globals": "^15.14.0",
    "prettier": "^3.4.2"
  }
}
```

Add testing devDependencies to apps/web/package.json:
```json
{
  "devDependencies": {
    "@testing-library/react": "^16.0.0",
    "@testing-library/dom": "^10.0.0",
    "happy-dom": "^17.0.0"
  }
}
```

Update scripts in apps/web/package.json and packages/api/package.json to use eslint:
- "lint": "eslint . --max-warnings 0"
- "test": "vitest run"

Run `bun install` at root.
  </action>
  <verify>bun install && bun pm ls</verify>
  <done>All testing and linting dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Configure Vitest for monorepo</name>
  <files>vitest.config.ts, apps/web/vitest.config.ts, packages/api/vitest.config.ts, apps/web/src/test/setup.ts</files>
  <action>
Create root vitest.config.ts:
```typescript
import { defineConfig } from "vitest/config"
import tsconfigPaths from "vite-tsconfig-paths"

export default defineConfig({
  plugins: [tsconfigPaths()],
  test: {
    // Vitest 3.2+ uses 'projects' for monorepo workspaces
    projects: [
      "apps/*/vitest.config.ts",
      "packages/*/vitest.config.ts",
    ],
  },
})
```

Create apps/web/vitest.config.ts:
```typescript
import { defineConfig } from "vitest/config"
import react from "@vitejs/plugin-react"
import tsconfigPaths from "vite-tsconfig-paths"

export default defineConfig({
  plugins: [tsconfigPaths(), react()],
  test: {
    name: "web",
    environment: "happy-dom",
    include: ["src/**/*.{test,spec}.{ts,tsx}"],
    globals: true,
    setupFiles: ["./src/test/setup.ts"],
  },
})
```

Create packages/api/vitest.config.ts:
```typescript
import { defineConfig } from "vitest/config"
import tsconfigPaths from "vite-tsconfig-paths"

export default defineConfig({
  plugins: [tsconfigPaths()],
  test: {
    name: "api",
    include: ["src/**/*.{test,spec}.ts"],
    globals: true,
  },
})
```

Create apps/web/src/test/setup.ts:
```typescript
import "@testing-library/dom"
```
  </action>
  <verify>cat vitest.config.ts && cat apps/web/vitest.config.ts</verify>
  <done>Vitest configured for monorepo with projects</done>
</task>

<task type="auto">
  <name>Task 3: Create initial test files</name>
  <files>apps/web/src/App.test.tsx, packages/api/src/routes/health.test.ts</files>
  <action>
Create apps/web/src/App.test.tsx:
```typescript
import { describe, it, expect } from "vitest"
import { render, screen } from "@testing-library/react"
import { App } from "./App"

describe("App", () => {
  it("renders the main heading", () => {
    render(<App />)
    expect(screen.getByRole("heading", { level: 1 })).toHaveTextContent(
      "Alvaro Cortes"
    )
  })

  it("shows construction message", () => {
    render(<App />)
    expect(screen.getByText(/en construcciÃ³n/i)).toBeInTheDocument()
  })
})
```

Create packages/api/src/routes/health.test.ts:
```typescript
import { describe, it, expect } from "vitest"
import { health } from "./health"

describe("Health endpoint", () => {
  it("returns status ok", async () => {
    const res = await health.request("/")
    const json = await res.json()

    expect(res.status).toBe(200)
    expect(json.status).toBe("ok")
    expect(json.service).toBe("alvarocortes-api")
  })

  it("includes timestamp", async () => {
    const res = await health.request("/")
    const json = await res.json()

    expect(json.timestamp).toBeDefined()
    expect(new Date(json.timestamp)).toBeInstanceOf(Date)
  })
})
```
  </action>
  <verify>cat apps/web/src/App.test.tsx && cat packages/api/src/routes/health.test.ts</verify>
  <done>Initial test files created for web and api packages</done>
</task>

<task type="auto">
  <name>Task 4: Configure ESLint and Prettier</name>
  <files>eslint.config.js, .prettierrc, .prettierignore</files>
  <action>
Create eslint.config.js (ESLint v9 flat config):
```javascript
import js from "@eslint/js"
import tseslint from "typescript-eslint"
import reactHooks from "eslint-plugin-react-hooks"
import reactRefresh from "eslint-plugin-react-refresh"
import globals from "globals"

export default tseslint.config(
  { ignores: ["**/dist/**", "**/node_modules/**", "**/.turbo/**"] },
  {
    extends: [js.configs.recommended, ...tseslint.configs.recommended],
    files: ["**/*.{ts,tsx}"],
    languageOptions: {
      ecmaVersion: 2022,
      globals: {
        ...globals.browser,
        ...globals.node,
      },
    },
    plugins: {
      "react-hooks": reactHooks,
      "react-refresh": reactRefresh,
    },
    rules: {
      ...reactHooks.configs.recommended.rules,
      "react-refresh/only-export-components": [
        "warn",
        { allowConstantExport: true },
      ],
      "@typescript-eslint/no-unused-vars": [
        "error",
        { argsIgnorePattern: "^_" },
      ],
    },
  }
)
```

Create .prettierrc:
```json
{
  "semi": false,
  "singleQuote": false,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 80
}
```

Create .prettierignore:
```
dist
node_modules
.turbo
bun.lockb
pnpm-lock.yaml
```
  </action>
  <verify>cat eslint.config.js && cat .prettierrc</verify>
  <done>ESLint flat config and Prettier configured</done>
</task>

<task type="auto">
  <name>Task 5: Update package scripts and verify</name>
  <files>apps/web/package.json, packages/api/package.json</files>
  <action>
Update apps/web/package.json scripts:
```json
{
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "test": "vitest run",
    "lint": "eslint . --max-warnings 0",
    "type-check": "tsc --noEmit"
  }
}
```

Update packages/api/package.json scripts:
```json
{
  "scripts": {
    "dev": "bun run --hot src/index.ts",
    "build": "bun build src/index.ts --outdir dist --target bun",
    "start": "bun run dist/index.js",
    "test": "vitest run",
    "lint": "eslint . --max-warnings 0",
    "type-check": "tsc --noEmit"
  }
}
```

Run tests to verify setup:
1. `bun test` at root should run both web and api tests
2. `bun lint` should check all packages
  </action>
  <verify>bun test && bun lint</verify>
  <done>All scripts updated, tests pass, lint passes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bun test` runs Vitest across all packages
- [ ] All initial tests pass (2 for web, 2 for api)
- [ ] `bun lint` passes without errors
- [ ] TypeScript compiles without errors
- [ ] Prettier formatting is applied
</verification>

<success_criteria>
- All tasks completed
- Vitest monorepo testing operational
- ESLint v9 flat config working
- Prettier configured for consistent formatting
- Initial test coverage for App and health endpoint
- Phase 1 infrastructure complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-monorepo-foundation/01-04-SUMMARY.md`
</output>
