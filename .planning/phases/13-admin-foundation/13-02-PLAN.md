---
phase: 13-admin-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/config.toml
  - supabase/migrations/20260126000000_create_cms_tables.sql
  - packages/shared/src/database.types.ts
autonomous: false

must_haves:
  truths:
    - "Database tables exist in Supabase"
    - "TypeScript types match database schema"
    - "RLS policies enable public reads"
  artifacts:
    - path: "supabase/migrations/20260126000000_create_cms_tables.sql"
      provides: "All CMS tables with RLS"
      contains: "create table posts"
    - path: "packages/shared/src/database.types.ts"
      provides: "Auto-generated TypeScript types"
      contains: "Database"
  key_links:
    - from: "supabase/migrations/*.sql"
      to: "Supabase database"
      via: "supabase db push"

user_setup:
  - service: supabase
    why: "Database for CMS content"
    env_vars:
      - name: SUPABASE_URL
        source: "Supabase Dashboard → Project Settings → API → Project URL"
      - name: SUPABASE_ANON_KEY
        source: "Supabase Dashboard → Project Settings → API → anon public key"
    account_setup:
      - url: "https://supabase.com/dashboard"
        skip_if: "Already have Supabase project for this repo"
    dashboard_config:
      - task: "Enable GitHub OAuth provider"
        location: "Authentication → Providers → GitHub"
        details: "Enable GitHub, add OAuth app credentials from GitHub Developer Settings"
---

<objective>
Create Supabase database schema with migrations for all CMS entities: posts, projects, timeline_entries, tech_categories, and technologies.

Purpose: Establish database foundation that Phase 14+ will build upon for CRUD operations.
Output: Applied migrations with RLS policies, generated TypeScript types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-admin-foundation/13-RESEARCH.md

Existing data structures to match:
@apps/web/src/data/posts.ts
@apps/web/src/data/timeline.ts
@apps/web/src/data/techStacks.ts
@apps/web/src/data/projects.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Supabase in project</name>
  <files>supabase/config.toml</files>
  <action>
Run from project root:
```bash
supabase init
```

This creates supabase/ directory with config.toml.

If Supabase CLI not installed globally:
```bash
npm install -g supabase
```

After init, link to remote project (if exists):
```bash
supabase link --project-ref YOUR_PROJECT_REF
```

Note: Project ref is in Supabase Dashboard URL: supabase.com/dashboard/project/[PROJECT_REF]
  </action>
  <verify>supabase/ directory exists with config.toml</verify>
  <done>Supabase initialized locally</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Confirm Supabase project exists and provide project reference</action>
  <instructions>
I need to link the local Supabase CLI to your remote project.

1. Go to https://supabase.com/dashboard
2. Find or create the project for alvarocortes.cl
3. Copy the project reference from the URL: supabase.com/dashboard/project/[THIS_PART]

Also ensure you have environment variables ready:
- SUPABASE_URL (Project Settings → API → Project URL)
- SUPABASE_ANON_KEY (Project Settings → API → anon public key)
  </instructions>
  <verification>supabase link succeeds with provided project ref</verification>
  <resume-signal>Paste project reference (e.g., "abcdefghijklmnop") or "skip" if no remote project yet</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create database migration</name>
  <files>supabase/migrations/20260126000000_create_cms_tables.sql</files>
  <action>
Create migration file with all CMS tables following research patterns:

1. Enum types:
   - post_status: draft, published, archived
   - timeline_entry_type: work, studies

2. Tables (in order):
   - posts: id, slug, title, excerpt, content, status, author, category, tags[], published_at, created_at, updated_at
   - projects: id, name, description, details, tech_stack[], image_url, live_url, repo_url, featured, display_order, created_at, updated_at
   - timeline_entries: id, type, period, title, organization, display_order, created_at, updated_at
   - tech_categories: id, name, display_order, created_at, updated_at
   - technologies: id, category_id (FK), name, icon, display_order, created_at, updated_at

3. Indexes for common queries

4. RLS policies:
   - Public SELECT for published posts
   - Public SELECT for all projects, timeline, tech
   - Admin policies with placeholder UUID (to be updated after first OAuth login)

Use placeholder 'ADMIN_UUID_PLACEHOLDER' for admin policies. We'll update after Phase 14 auth setup.
  </action>
  <verify>File exists and has valid SQL syntax</verify>
  <done>Migration file created with all tables and RLS</done>
</task>

<task type="auto">
  <name>Task 3: Apply migration and generate types</name>
  <files>packages/shared/src/database.types.ts</files>
  <action>
If linked to remote project:
```bash
supabase db push
```

Generate TypeScript types:
```bash
supabase gen types typescript --linked > packages/shared/src/database.types.ts
```

If not linked (local only):
```bash
supabase db reset  # Apply migrations locally
supabase gen types typescript --local > packages/shared/src/database.types.ts
```

Export types from packages/shared/src/index.ts:
```typescript
export * from './database.types'
```
  </action>
  <verify>database.types.ts exists with Database type, packages/shared exports it</verify>
  <done>Types generated and exported from shared package</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] supabase/migrations/ contains SQL migration file
- [ ] packages/shared/src/database.types.ts exists with Database type
- [ ] If linked: tables visible in Supabase Dashboard
- [ ] `bun run type-check` at root passes (types are valid)
</verification>

<success_criteria>

- All tasks completed
- Migration file has all 5 tables with proper constraints
- RLS enabled on all tables
- TypeScript types generated and exported
  </success_criteria>

<output>
After completion, create `.planning/phases/13-admin-foundation/13-02-SUMMARY.md`
</output>
